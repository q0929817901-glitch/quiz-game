<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™‚ç©ºä¿®å¾©å±€ V4.3ï¼šç„¡é™ç–ŠåŠ ç‰ˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&family=Press+Start+2P&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root { --bg: #0f172a; --panel: rgba(30, 41, 59, 0.95); --accent: #3b82f6; --text: #e2e8f0; --gold: #f59e0b; }
        * { box-sizing: border-box; user-select: none; }
        body { background: var(--bg); color: var(--text); font-family: 'Noto Sans TC', sans-serif; margin: 0; height: 100vh; overflow: hidden; display: flex; justify-content: center; align-items: center; background-image: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
        .game-wrapper { width: 100%; max-width: 800px; height: 95vh; background: var(--panel); border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; position: relative; backdrop-filter: blur(10px); }
        .hud { padding: 15px 25px; background: rgba(0,0,0,0.4); border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; border-radius: 20px 20px 0 0; }
        .stat-item { display: flex; flex-direction: column; align-items: center; }
        .stat-label { font-size: 0.7rem; color: #94a3b8; text-transform: uppercase; }
        .stat-value { font-family: 'Press Start 2P'; color: var(--accent); font-size: 1rem; margin-top: 5px; }
        .progress-line { height: 4px; background: #334155; width: 100%; }
        .progress-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.3s ease; }
        .content-area { flex: 1; padding: 20px 40px; display: flex; flex-direction: column; justify-content: center; overflow-y: auto; }
        .tag { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; margin-bottom: 15px; background: rgba(59, 130, 246, 0.2); color: #93c5fd; }
        .question { font-size: 1.5rem; line-height: 1.6; font-weight: 700; margin-bottom: 30px; text-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        .options { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .opt-btn { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); padding: 20px; border-radius: 12px; color: var(--text); font-size: 1.1rem; cursor: pointer; transition: all 0.2s; text-align: left; }
        .opt-btn:hover { background: rgba(59, 130, 246, 0.2); border-color: var(--accent); transform: translateY(-2px); }
        .opt-btn.correct { background: rgba(34, 197, 94, 0.25); border-color: #22c55e; color: #4ade80; }
        .opt-btn.wrong { background: rgba(239, 68, 68, 0.25); border-color: #ef4444; opacity: 0.6; animation: shake 0.4s; }
        .explanation { margin-top: 25px; padding: 20px; background: rgba(15, 23, 42, 0.95); border-left: 4px solid var(--gold); border-radius: 0 8px 8px 0; display: none; animation: slideIn 0.3s ease; }
        .explanation.show { display: block; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* æŒ‰éˆ•æ¨£å¼ */
        .next-btn { margin-top: 20px; padding: 16px; width: 100%; background: var(--text); color: var(--bg); border: none; border-radius: 10px; font-weight: 900; font-size: 1.2rem; cursor: pointer; display: none; }
        .next-btn:hover { filter: brightness(1.2); }
        
        .overlay-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 50; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; }
        .big-title { font-size: 2.5rem; font-weight: 900; margin-bottom: 10px; color: var(--accent); }
        .paste-area { width: 80%; height: 120px; background: #1e293b; border: 1px solid #475569; color: #cbd5e1; border-radius: 10px; padding: 10px; font-family: monospace; font-size: 0.9rem; margin-bottom: 10px; resize: none; }
        .paste-area:focus { outline: 2px solid var(--accent); border-color: transparent; }
        .action-row { display: flex; gap: 10px; margin-bottom: 20px; }
        
        .btn-load { background: #475569; color: white; padding: 10px 20px; border-radius: 8px; border:none; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .btn-load:hover { background: #64748b; }
        .btn-clear { background: #ef4444; color: white; }
        .btn-clear:hover { background: #dc2626; }

        .mode-btn { padding: 15px 40px; margin: 10px; font-size: 1.2rem; border-radius: 50px; border: none; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 10px; opacity: 0.5; pointer-events: none; transition: all 0.3s; }
        .mode-btn.active { opacity: 1; pointer-events: auto; transform: scale(1); }
        .btn-exam { background: var(--gold); color: #000; }
        .btn-endless { background: var(--accent); color: #fff; }
        #statusMsg { height: 20px; font-size: 0.9rem; color: #f87171; margin-bottom: 10px; }
        
        /* é¡Œåº«è¨ˆæ•¸å™¨ */
        .count-badge { background: var(--accent); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; margin-left: 5px; }

        @media (max-width: 768px) { .game-wrapper { height: 100vh; border-radius: 0; } .big-title { font-size: 2rem; } .paste-area { width: 95%; } }
    </style>
</head>
<body>

<div class="game-wrapper">
    <div class="progress-line"><div class="progress-fill" id="progressBar"></div></div>
    <div class="hud">
        <div class="stat-item"><span class="stat-label">Combo</span><span class="stat-value" id="comboVal">0</span></div>
        <div class="stat-item"><span class="stat-label">å‰©é¤˜é¡Œæ•¸</span><span class="stat-value" id="remainVal">--</span></div>
        <div class="stat-item"><span class="stat-label">Score</span><span class="stat-value" id="scoreVal">0</span></div>
    </div>
    
    <div class="content-area">
        <div class="tag" id="qTag">æº–å‚™ä¸­...</div>
        <div class="question" id="qText"></div>
        <div class="options" id="optContainer"></div>
        <div class="explanation" id="expBox">
            <div style="font-size:0.9rem; color:#94a3b8; margin-bottom:5px;"><i class="bi bi-info-circle-fill" style="color:var(--gold)"></i> è§£æ</div>
            <div id="expText" style="line-height:1.6; font-size:1.1rem;"></div>
        </div>
        
        <button class="next-btn" id="nextBtn" onclick="loadNextQuestion()">ä¸‹ä¸€é¡Œ <i class="bi bi-arrow-right-short"></i></button>
    </div>

    <div class="overlay-screen" id="startScreen">
        <div class="big-title">æ™‚ç©ºä¿®å¾©å±€ V4.3</div>
        <div style="color: #94a3b8; margin-bottom: 15px; font-size: 0.9rem;">
            åˆ†æ‰¹è²¼ä¸Š JSONï¼Œé¡Œåº«æœƒè‡ªå‹•ç´¯åŠ ï¼
        </div>
        
        <textarea id="pasteArea" placeholder='[ { "q": "...", "options": ["A","B"], "ans": 0, "exp": "..." } ]'></textarea>
        <div id="statusMsg"></div>

        <div class="action-row">
            <button class="btn-load" onclick="loadFromText()"><i class="bi bi-plus-circle-fill"></i> åŠ å…¥é¡Œåº«</button>
            <button class="btn-load btn-clear" onclick="clearData()"><i class="bi bi-trash3-fill"></i> æ¸…ç©ºé‡ç½®</button>
        </div>

        <div style="display:flex; flex-direction:column; align-items:center;">
            <button class="mode-btn btn-exam" id="btnExam" onclick="startGame('exam')"><i class="bi bi-pencil-square"></i> æ®µè€ƒæ¨¡æ“¬</button>
            <button class="mode-btn btn-endless" id="btnEndless" onclick="startGame('endless')"><i class="bi bi-infinity"></i> ç„¡ç›¡åˆ·é¡Œ</button>
        </div>
        
        <div style="margin-top:20px; font-size:0.8rem; color:#475569;">
            ç›®å‰ç¸½é¡Œæ•¸: <span id="totalQCount" style="color:var(--accent); font-weight:bold; font-size: 1.2rem;">0</span> é¡Œ
        </div>
    </div>

    <div class="overlay-screen" id="endScreen" style="display:none;">
        <div class="big-title">ä»»å‹™å®Œæˆ</div>
        <div style="font-size: 4rem; color: var(--gold); margin: 20px 0; font-family: 'Press Start 2P';" id="finalScore">0</div>
        <p id="endDesc" style="color:#cbd5e1; max-width: 80%;">...</p>
        <button class="mode-btn active btn-endless" onclick="location.reload()">å†æ¬¡æŒ‘æˆ°</button>
    </div>
</div>

<script>
    let globalData = [];
    let questionPool=[], currentQ=null, score=0, combo=0, mode='exam', qCount=0, maxQ=20;

    // 1. è¼‰å…¥é¡Œåº« (ç´¯åŠ æ¨¡å¼)
    function loadFromText() {
        const input = document.getElementById('pasteArea');
        const text = input.value;
        const msg = document.getElementById('statusMsg');
        
        if(!text.trim()) { msg.innerText = "âš ï¸ æ¡†æ¡†æ˜¯ç©ºçš„ï¼Œè«‹å…ˆè²¼ä¸Šé¡Œç›®ï¼"; msg.style.color = "#facc15"; return; }
        
        try {
            // æ¸…ç†æ ¼å¼
            let cleanText = text.replace(/```json/g, '').replace(/```/g, '').trim();
            cleanText = cleanText.replace(/,(\s*])/, '$1'); 
            const json = JSON.parse(cleanText);
            
            if(Array.isArray(json)) {
                // â˜… é—œéµä¿®æ”¹ï¼šä½¿ç”¨ concat é€²è¡Œç´¯åŠ  â˜…
                const prevCount = globalData.length;
                globalData = globalData.concat(json);
                const newCount = globalData.length;
                const added = newCount - prevCount;

                updateUI(true);
                
                // æˆåŠŸæç¤º
                msg.innerHTML = `âœ… æˆåŠŸåŠ å…¥ <b>${added}</b> é¡Œï¼ç›®å‰ç¸½å…± <b>${newCount}</b> é¡Œã€‚`;
                msg.style.color = "#4ade80";
                
                // æ¸…ç©ºè¼¸å…¥æ¡†ï¼Œæ–¹ä¾¿è²¼ä¸‹ä¸€æ‰¹
                input.value = "";
                input.focus();
            } else { throw new Error("ä¸æ˜¯é™£åˆ—"); }
        } catch (e) {
            msg.innerText = "âŒ æ ¼å¼éŒ¯èª¤ï¼è«‹ç¢ºèªåŒ…å« [ å’Œ ]";
            msg.style.color = "#f87171";
            console.error(e);
        }
    }

    // 2. æ¸…ç©ºé¡Œåº«
    function clearData() {
        globalData = [];
        updateUI(false);
        document.getElementById('statusMsg').innerText = "ğŸ—‘ï¸ é¡Œåº«å·²æ¸…ç©ºï¼Œè«‹é‡æ–°åŠ å…¥ã€‚";
        document.getElementById('statusMsg').style.color = "#94a3b8";
    }

    function updateUI(ready) {
        document.getElementById('totalQCount').innerText = globalData.length;
        const btns = document.querySelectorAll('.mode-btn');
        btns.forEach(b => { 
            if(globalData.length > 0) b.classList.add('active'); // åªè¦æœ‰é¡Œç›®å°±èƒ½ç©
            else b.classList.remove('active');
        });
    }

    function startGame(m) {
        mode=m; score=0; combo=0; qCount=0;
        // éš¨æ©Ÿæ´—ç‰Œ
        questionPool = [...globalData].sort(()=>Math.random()-0.5);
        // è¨­å®šæœ€å¤§é¡Œæ•¸
        maxQ = (mode==='exam') ? Math.min(20, questionPool.length) : 999;
        
        document.getElementById('startScreen').style.display='none';
        document.getElementById('endScreen').style.display='none';
        updateStats(); 
        loadNextQuestion(); 
    }

    function loadNextQuestion() {
        if((mode==='exam' && qCount>=maxQ) || questionPool.length===0) { 
            finishGame(); 
            return; 
        }
        
        currentQ = questionPool.pop(); 
        qCount++;
        document.getElementById('qTag').innerText = currentQ.dynasty||'æ­·å²';
        document.getElementById('qText').innerText = currentQ.q;
        const c = document.getElementById('optContainer'); c.innerHTML='';
        document.getElementById('expBox').classList.remove('show');
        document.getElementById('nextBtn').style.display='none';
        
        currentQ.options.forEach((o,i)=>{
            const b=document.createElement('button'); b.className='opt-btn'; b.innerText=o;
            b.onclick=()=>checkAnswer(b,i); c.appendChild(b);
        });
        document.getElementById('progressBar').style.width = (mode==='exam' ? (qCount/maxQ)*100 : 100)+'%';
        updateStats();
    }

    function checkAnswer(btn, idx) {
        document.querySelectorAll('.opt-btn').forEach(b=>b.disabled=true);
        if(idx===currentQ.ans) {
            btn.classList.add('correct'); score+=100+(combo*10); combo++; triggerConfetti();
        } else {
            btn.classList.add('wrong'); document.querySelectorAll('.opt-btn')[currentQ.ans].classList.add('correct'); combo=0;
            if(mode==='endless') { setTimeout(()=>finishGame("ç”Ÿå­˜æ¨¡å¼çµæŸ"), 1500); return; }
        }
        document.getElementById('expText').innerText = currentQ.exp;
        document.getElementById('expBox').classList.add('show');
        document.getElementById('nextBtn').style.display='block';
        updateStats();
    }

    function updateStats(){
        document.getElementById('scoreVal').innerText=score; document.getElementById('comboVal').innerText=combo;
        document.getElementById('remainVal').innerText = mode==='exam'?(maxQ-qCount):'âˆ';
    }

    function finishGame(msg) {
        document.getElementById('endScreen').style.display='flex'; 
        document.getElementById('finalScore').innerText=score;
        document.getElementById('endDesc').innerText = msg || (score>=1500?"å¤ªç¥äº†ï¼":"å†æ¥å†å²ï¼");
        if(score>1000) triggerConfetti();
    }

    function triggerConfetti() { confetti({particleCount:80, spread:60, origin:{y:0.7}, colors:['#3b82f6','#f59e0b','#22c55e']}); }
</script>
</body>
</html>
